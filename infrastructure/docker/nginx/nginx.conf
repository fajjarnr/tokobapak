events {
    worker_connections 1024;
}

http {
    include       mime.types;
    default_type  application/json;

    # Upstream definitions
    upstream product_service { server product-service:3001; }
    upstream catalog_service { server catalog-service:3002; }
    upstream cart_service { server cart-service:3003; }
    upstream order_service { server order-service:3004; }
    upstream payment_service { server payment-service:3005; }
    upstream user_service { server user-service:3006; }
    upstream auth_service { server auth-service:3007; }
    upstream shipping_service { server shipping-service:3008; }
    upstream notification_service { server notification-service:3009; }
    upstream review_service { server review-service:3010; }
    upstream inventory_service { server inventory-service:3011; }
    upstream search_service { server search-service:3012; }
    upstream chat_service { server chat-service:3013; }
    upstream recommendation_service { server recommendation-service:3014; }
    upstream media_service { server media-service:3015; }
    upstream seller_service { server seller-service:3016; }
    upstream analytics_service { server analytics-service:3017; }
    upstream promotion_service { server promotion-service:3018; }

    server {
        listen 80;
        server_name localhost;

        # CORS Headers
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
        add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
        add_header 'Access-Control-Expose-Headers' 'Content-Length,Content-Range' always;

        location / {
            if ($request_method = 'OPTIONS') {
                add_header 'Access-Control-Allow-Origin' '*' always;
                add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS, PUT, DELETE, PATCH' always;
                add_header 'Access-Control-Allow-Headers' 'DNT,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Range,Authorization' always;
                add_header 'Access-Control-Max-Age' 1728000;
                add_header 'Content-Type' 'text/plain; charset=utf-8';
                add_header 'Content-Length' 0;
                return 204;
            }
        }

        # Routes
        location /api/v1/products { proxy_pass http://product_service; }
        location /api/v1/categories { proxy_pass http://catalog_service; }
        location /api/v1/cart { proxy_pass http://cart_service; }
        location /api/v1/orders { proxy_pass http://order_service; }
        location /api/v1/payments { proxy_pass http://payment_service; }
        location /api/v1/users { proxy_pass http://user_service; }
        location /api/v1/auth { proxy_pass http://auth_service; }
        location /api/v1/shipping { proxy_pass http://shipping_service; }
        location /api/v1/notifications { proxy_pass http://notification_service; }
        location /api/v1/reviews { proxy_pass http://review_service; }
        location /api/v1/inventory { proxy_pass http://inventory_service; }
        location /api/v1/search { proxy_pass http://search_service; }
        location /api/v1/chat { proxy_pass http://chat_service; }
        location /api/v1/recommendations { proxy_pass http://recommendation_service; }
        location /api/v1/media { proxy_pass http://media_service; }
        location /api/v1/sellers { proxy_pass http://seller_service; }
        location /api/v1/analytics { proxy_pass http://analytics_service; }
        location /api/v1/promotions { proxy_pass http://promotion_service; }

        # Health check
        location /health {
            return 200 '{"status":"UP"}';
        }
    }
}
